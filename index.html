<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Japanese Kana Quiz — Romaji ⇄ ひらがな・カタカナ</title>
  <style>
    :root {
      --bg: #f8fafc; /* slate-50 */
      --card: #ffffff;
      --border: #e2e8f0; /* slate-200 */
      --text: #0f172a;   /* slate-900 */
      --muted: #475569;  /* slate-600 */
      --accent: #4f46e5; /* indigo-600 */
      --accent-2: #4338ca; /* indigo-700 */
      --ok: #16a34a;     /* green-600 */
      --err: #dc2626;    /* red-600 */
      --good-bg: #ecfdf5; /* green-50 */
      --bad-bg: #fef2f2;  /* red-50 */
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    header { position: sticky; top: 0; backdrop-filter: blur(6px); background: rgba(255,255,255,0.8); border-bottom: 1px solid var(--border); }
    .container { max-width: 1000px; margin: 0 auto; padding: 16px; }
    h1 { font-size: clamp(20px, 3vw, 32px); margin: 0; font-weight: 800; }
    .sub { color: var(--muted); font-size: 12px; }

    .grid { display: grid; gap: 12px; }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
    .btn { display: inline-block; padding: 10px 14px; border-radius: 12px; border: 1px solid var(--border); background: #f8fafc; cursor: pointer; font-weight: 600; }
    .btn:hover { filter: brightness(0.98); }
    .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
    .btn-primary:hover { background: var(--accent-2); }

    .row { display:flex; align-items:center; justify-content: space-between; gap: 8px; }
    label { display:flex; align-items:center; gap:8px; font-size: 14px; }
    select, input[type="number"], input[type="text"] { padding: 8px 10px; border-radius: 8px; border:1px solid var(--border); font-size:14px; }

    .stat { text-align:center; }
    .stat .name { font-size: 12px; color: var(--muted); }
    .stat .val { font-size: 24px; font-weight: 800; }

    .prompt { text-align:center; margin: 16px 0 24px; }
    .prompt .hint { color: var(--muted); font-size: 13px; }
    .prompt .romaji { font-size: clamp(48px, 10vw, 80px); font-weight: 900; letter-spacing: 2px; }

    .choices { display:grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
    .choice { padding: 16px; border: 1px solid var(--border); border-radius: 14px; background: #f1f5f9; font-size: 28px; font-weight: 800; cursor:pointer; text-align:left; }
    .choice:hover { background: #e2e8f0; }

    .msg { min-height: 22px; font-size: 14px; }
    .msg.ok { color: var(--ok); }
    .msg.err { color: var(--err); }

    details summary { cursor: pointer; font-weight: 700; }
    .chart { margin-top: 12px; display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); }
    .cell { border:1px solid var(--border); border-radius:12px; padding:10px; text-align:center; }
    .cell .k { font-size: 28px; font-weight: 800; }
    .cell .r { font-size: 12px; color: var(--muted); }

    .history { display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
    .h-item { border:1px solid var(--border); border-radius:12px; padding:10px; }
    .h-good { background: var(--good-bg); border-color:#bbf7d0; }
    .h-bad { background: var(--bad-bg); border-color:#fecaca; }

    footer { color: var(--muted); font-size: 12px; text-align:center; padding: 24px 0 40px; }
  </style>
</head>
<body>
  <header>
    <div class="container row">
      <h1 id="title">Japanese Kana Quiz — Romaji → ひらがな</h1>
      <div class="sub" id="kbdHint">Press 1–4 to answer · Space to skip</div>
    </div>
  </header>

  <main class="container">
    <!-- Controls -->
    <section class="grid grid-3">
      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px; font-weight:700;">Script Type</h2>
        <div class="row" style="margin-bottom:8px;">
          <span>Writing system</span>
          <select id="optScript">
            <option value="hiragana" selected>Hiragana ひらがな</option>
            <option value="katakana">Katakana カタカナ</option>
            <option value="mixed">Mixed ひらがな・カタカナ</option>
          </select>
        </div>
        <label><input type="checkbox" id="optDakuten" /> Include dakuten/handakuten (が・ぱ…)</label>
        <label><input type="checkbox" id="optYoon" /> Include yōon combos (きゃ・しゅ・りょ)</label>
      </div>
      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px; font-weight:700;">Quiz Settings</h2>
        <div class="row" style="margin-bottom:8px;">
          <span>Direction</span>
          <select id="optDirection">
            <option value="r2k" selected>Romaji → japanese</option>
            <option value="k2r">japanese → Romaji</option>
          </select>
        </div>
        <div class="row" style="margin-bottom:8px;">
          <span>Choices per question</span>
          <select id="optChoices">
            <option>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
            <option>7</option>
            <option>8</option>
            <option>9</option>
            <option selected >10</option>
          </select>
        </div>
        <div class="row">
          <span>Pool size</span>
          <input type="number" id="optPool" min="10" value="92" style="width:90px" />
        </div>
      </div>
      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px; font-weight:700;">Timer</h2>
        <label style="margin-bottom:8px;"><input type="checkbox" id="optTimer" /> Show timer</label>
        <button class="btn btn-primary" id="btnStart">Start Quiz</button>
        <div class="sub" id="timer" style="text-align:right; margin-top:8px;">⏱️ 0:00</div>
      </div>
    </section>

    <!-- Dashboard -->
    <section class="grid grid-4" style="margin-top:12px;">
      <div class="card stat"><div class="name">Score</div><div class="val" id="statScore">0</div></div>
      <div class="card stat"><div class="name">Questions</div><div class="val" id="statAsked">0</div></div>
      <div class="card stat"><div class="name">Accuracy</div><div class="val" id="statAcc">0%</div></div>
      <div class="card stat"><div class="name">Streak / Best</div><div class="val"><span id="statStreak">0</span> <span class="sub">/ <span id="statBest">0</span></span></div></div>
    </section>

    <!-- Quiz Card -->
    <section class="card" style="margin-top:12px;" id="quizCard">
      <div id="preStart" class="prompt">
        <p>Choose your settings above and press <strong>Start Quiz</strong>.</p>
      </div>
      <div id="quiz" hidden>
        <div class="prompt">
          <div class="hint" id="hint">Romaji</div>
          <div class="romaji" id="prompt">ka</div>
        </div>
        <div class="choices" id="choices"></div>
        <div class="row" style="margin-top:8px;">
          <div class="msg" id="msg">&nbsp;</div>
          <div class="row" style="gap:8px;">
            <button class="btn" id="btnSkip" title="Space">Skip</button>
            <button class="btn" id="btnReveal">Reveal</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Study chart -->
    <section style="margin-top:12px;">
      <details class="card">
        <summary>Study chart (tap to expand)</summary>
        <div class="chart" id="chart"></div>
      </details>
    </section>

    <!-- History -->
    <section style="margin-top:12px;" id="historyWrap" hidden>
      <h3 style="margin: 0 0 8px;">Recent answers</h3>
      <div class="history" id="history"></div>
    </section>
  </main>

  <footer>
    Built for practice. Tip: keep dakuten/yōon off at first, then add them later.
  </footer>

  <script>
    // ===== Data =====
    const BASE_HIRAGANA = [
      { r: "a", k: "あ" }, { r: "i", k: "い" }, { r: "u", k: "う" }, { r: "e", k: "え" }, { r: "o", k: "お" },
      { r: "ka", k: "か" }, { r: "ki", k: "き" }, { r: "ku", k: "く" }, { r: "ke", k: "け" }, { r: "ko", k: "こ" },
      { r: "sa", k: "さ" }, { r: "shi", k: "し" }, { r: "su", k: "す" }, { r: "se", k: "せ" }, { r: "so", k: "そ" },
      { r: "ta", k: "た" }, { r: "chi", k: "ち" }, { r: "tsu", k: "つ" }, { r: "te", k: "て" }, { r: "to", k: "と" },
      { r: "na", k: "な" }, { r: "ni", k: "に" }, { r: "nu", k: "ぬ" }, { r: "ne", k: "ね" }, { r: "no", k: "の" },
      { r: "ha", k: "は" }, { r: "hi", k: "ひ" }, { r: "fu", k: "ふ" }, { r: "he", k: "へ" }, { r: "ho", k: "ほ" },
      { r: "ma", k: "ま" }, { r: "mi", k: "み" }, { r: "mu", k: "む" }, { r: "me", k: "め" }, { r: "mo", k: "も" },
      { r: "ya", k: "や" }, { r: "yu", k: "ゆ" }, { r: "yo", k: "よ" },
      { r: "ra", k: "ら" }, { r: "ri", k: "り" }, { r: "ru", k: "る" }, { r: "re", k: "れ" }, { r: "ro", k: "ろ" },
      { r: "wa", k: "わ" }, { r: "wo", k: "を" }, { r: "n", k: "ん" },
    ];

    const BASE_KATAKANA = [
      { r: "a", k: "ア" }, { r: "i", k: "イ" }, { r: "u", k: "ウ" }, { r: "e", k: "エ" }, { r: "o", k: "オ" },
      { r: "ka", k: "カ" }, { r: "ki", k: "キ" }, { r: "ku", k: "ク" }, { r: "ke", k: "ケ" }, { r: "ko", k: "コ" },
      { r: "sa", k: "サ" }, { r: "shi", k: "シ" }, { r: "su", k: "ス" }, { r: "se", k: "セ" }, { r: "so", k: "ソ" },
      { r: "ta", k: "タ" }, { r: "chi", k: "チ" }, { r: "tsu", k: "ツ" }, { r: "te", k: "テ" }, { r: "to", k: "ト" },
      { r: "na", k: "ナ" }, { r: "ni", k: "ニ" }, { r: "nu", k: "ヌ" }, { r: "ne", k: "ネ" }, { r: "no", k: "ノ" },
      { r: "ha", k: "ハ" }, { r: "hi", k: "ヒ" }, { r: "fu", k: "フ" }, { r: "he", k: "ヘ" }, { r: "ho", k: "ホ" },
      { r: "ma", k: "マ" }, { r: "mi", k: "ミ" }, { r: "mu", k: "ム" }, { r: "me", k: "メ" }, { r: "mo", k: "モ" },
      { r: "ya", k: "ヤ" }, { r: "yu", k: "ユ" }, { r: "yo", k: "ヨ" },
      { r: "ra", k: "ラ" }, { r: "ri", k: "リ" }, { r: "ru", k: "ル" }, { r: "re", k: "レ" }, { r: "ro", k: "ロ" },
      { r: "wa", k: "ワ" }, { r: "wo", k: "ヲ" }, { r: "n", k: "ン" },
    ];

    const DAKUTEN_HIRAGANA = [
      { r: "ga", k: "が" }, { r: "gi", k: "ぎ" }, { r: "gu", k: "ぐ" }, { r: "ge", k: "げ" }, { r: "go", k: "ご" },
      { r: "za", k: "ざ" }, { r: "ji", k: "じ" }, { r: "zu", k: "ず" }, { r: "ze", k: "ぜ" }, { r: "zo", k: "ぞ" },
      { r: "da", k: "だ" }, { r: "ji", k: "ぢ" }, { r: "zu", k: "づ" }, { r: "de", k: "で" }, { r: "do", k: "ど" },
      { r: "ba", k: "ば" }, { r: "bi", k: "び" }, { r: "bu", k: "ぶ" }, { r: "be", k: "べ" }, { r: "bo", k: "ぼ" },
      { r: "pa", k: "ぱ" }, { r: "pi", k: "ぴ" }, { r: "pu", k: "ぷ" }, { r: "pe", k: "ぺ" }, { r: "po", k: "ぽ" },
    ];

    const DAKUTEN_KATAKANA = [
      { r: "ga", k: "ガ" }, { r: "gi", k: "ギ" }, { r: "gu", k: "グ" }, { r: "ge", k: "ゲ" }, { r: "go", k: "ゴ" },
      { r: "za", k: "ザ" }, { r: "ji", k: "ジ" }, { r: "zu", k: "ズ" }, { r: "ze", k: "ゼ" }, { r: "zo", k: "ゾ" },
      { r: "da", k: "ダ" }, { r: "ji", k: "ヂ" }, { r: "zu", k: "ヅ" }, { r: "de", k: "デ" }, { r: "do", k: "ド" },
      { r: "ba", k: "バ" }, { r: "bi", k: "ビ" }, { r: "bu", k: "ブ" }, { r: "be", k: "ベ" }, { r: "bo", k: "ボ" },
      { r: "pa", k: "パ" }, { r: "pi", k: "ピ" }, { r: "pu", k: "プ" }, { r: "pe", k: "ペ" }, { r: "po", k: "ポ" },
    ];

    const YOON_HIRAGANA = [
      { r: "kya", k: "きゃ" }, { r: "kyu", k: "きゅ" }, { r: "kyo", k: "きょ" },
      { r: "gya", k: "ぎゃ" }, { r: "gyu", k: "ぎゅ" }, { r: "gyo", k: "ぎょ" },
      { r: "sha", k: "しゃ" }, { r: "shu", k: "しゅ" }, { r: "sho", k: "しょ" },
      { r: "ja", k: "じゃ" }, { r: "ju", k: "じゅ" }, { r: "jo", k: "じょ" },
      { r: "cha", k: "ちゃ" }, { r: "chu", k: "ちゅ" }, { r: "cho", k: "ちょ" },
      { r: "dya", k: "ぢゃ" }, { r: "dyu", k: "ぢゅ" }, { r: "dyo", k: "ぢょ" },
      { r: "nya", k: "にゃ" }, { r: "nyu", k: "にゅ" }, { r: "nyo", k: "にょ" },
      { r: "hya", k: "ひゃ" }, { r: "hyu", k: "ひゅ" }, { r: "hyo", k: "ひょ" },
      { r: "bya", k: "びゃ" }, { r: "byu", k: "びゅ" }, { r: "byo", k: "びょ" },
      { r: "pya", k: "ぴゃ" }, { r: "pyu", k: "ぴゅ" }, { r: "pyo", k: "ぴょ" },
      { r: "mya", k: "みゃ" }, { r: "myu", k: "みゅ" }, { r: "myo", k: "みょ" },
      { r: "rya", k: "りゃ" }, { r: "ryu", k: "りゅ" }, { r: "ryo", k: "りょ" },
    ];

    const YOON_KATAKANA = [
      { r: "kya", k: "キャ" }, { r: "kyu", k: "キュ" }, { r: "kyo", k: "キョ" },
      { r: "gya", k: "ギャ" }, { r: "gyu", k: "ギュ" }, { r: "gyo", k: "ギョ" },
      { r: "sha", k: "シャ" }, { r: "shu", k: "シュ" }, { r: "sho", k: "ショ" },
      { r: "ja", k: "ジャ" }, { r: "ju", k: "ジュ" }, { r: "jo", k: "ジョ" },
      { r: "cha", k: "チャ" }, { r: "chu", k: "チュ" }, { r: "cho", k: "チョ" },
      { r: "dya", k: "ヂャ" }, { r: "dyu", k: "ヂュ" }, { r: "dyo", k: "ヂョ" },
      { r: "nya", k: "ニャ" }, { r: "nyu", k: "ニュ" }, { r: "nyo", k: "ニョ" },
      { r: "hya", k: "ヒャ" }, { r: "hyu", k: "ヒュ" }, { r: "hyo", k: "ヒョ" },
      { r: "bya", k: "ビャ" }, { r: "byu", k: "ビュ" }, { r: "byo", k: "ビョ" },
      { r: "pya", k: "ピャ" }, { r: "pyu", k: "ピュ" }, { r: "pyo", k: "ピョ" },
      { r: "mya", k: "ミャ" }, { r: "myu", k: "ミュ" }, { r: "myo", k: "ミョ" },
      { r: "rya", k: "リャ" }, { r: "ryu", k: "リュ" }, { r: "ryo", k: "リョ" },
    ];

    // ===== Helpers =====
    const $ = (sel) => document.querySelector(sel);
    function shuffle(arr) { const a = arr.slice(); for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function sample(arr, n) { return shuffle(arr).slice(0, n); }
    function dedupe(p){ const m=new Map(); for(const it of p){ const key=it.r+"::"+it.k; if(!m.has(key)) m.set(key,it); } return Array.from(m.values()); }

    // ===== State =====
    const state = {
      scriptType: 'hiragana', // 'hiragana', 'katakana', or 'mixed'
      includeDakuten: false,
      includeYoon: false,
      mode: 'r2k', // 'r2k' Romaji->Kana, 'k2r' Kana->Romaji
      choicesCount: 10,
      poolSize: 92,
      inProgress: false,
      question: null, // {prompt, answer, options}
      score: 0,
      asked: 0,
      message: "",
      history: [], // {r,k,correct,chosen}
      streak: 0,
      bestStreak: 0,
      timerOn: false,
      seconds: 0,
      tick: null,
      currentPool: [],
      queue: []
    };

    function fullPool(){
      let p = [];
      
      if (state.scriptType === 'hiragana') {
        p = BASE_HIRAGANA.slice();
        if (state.includeDakuten) {
          p = p.concat(DAKUTEN_HIRAGANA);
        }
        if (state.includeYoon) {
          p = p.concat(YOON_HIRAGANA);
        }
      } else if (state.scriptType === 'katakana') {
        p = BASE_KATAKANA.slice();
        if (state.includeDakuten) {
          p = p.concat(DAKUTEN_KATAKANA);
        }
        if (state.includeYoon) {
          p = p.concat(YOON_KATAKANA);
        }
      } else if (state.scriptType === 'mixed') {
        p = BASE_HIRAGANA.slice().concat(BASE_KATAKANA);
        if (state.includeDakuten) {
          p = p.concat(DAKUTEN_HIRAGANA).concat(DAKUTEN_KATAKANA);
        }
        if (state.includeYoon) {
          p = p.concat(YOON_HIRAGANA).concat(YOON_KATAKANA);
        }
      }
      
      return dedupe(p);
    }

    function buildPoolAndQueue(){
      const fp = fullPool();
      const n = Math.min(state.poolSize, fp.length);
      state.currentPool = fp.slice().sort(() => Math.random() - 0.5).slice(0, n);
      state.queue = state.currentPool.slice().sort(() => Math.random() - 0.5);
      // make sure choicesCount never exceeds pool size
      if (state.choicesCount > state.currentPool.length) {
        state.choicesCount = Math.max(2, state.currentPool.length);
        optChoices.value = String(state.choicesCount);
      }
    }

    // ===== UI Bindings =====
    const optScript = $('#optScript');
    const optDakuten = $('#optDakuten');
    const optYoon = $('#optYoon');
    const optChoices = $('#optChoices');
    const optDirection = $('#optDirection');
    const optPool = $('#optPool');
    const optTimer = $('#optTimer');
    const btnStart = $('#btnStart');
    const timerEl = $('#timer');
    const titleEl = $('#title');

    const statScore = $('#statScore');
    const statAsked = $('#statAsked');
    const statAcc = $('#statAcc');
    const statStreak = $('#statStreak');
    const statBest = $('#statBest');

    const preStart = $('#preStart');
    const quiz = $('#quiz');
    const promptEl = $('#prompt');
    const choicesEl = $('#choices');
    const msgEl = $('#msg');
    const btnSkip = $('#btnSkip');
    const btnReveal = $('#btnReveal');
    const chart = $('#chart');
    const historyWrap = $('#historyWrap');
    const historyEl = $('#history');
    const kbdHint = $('#kbdHint');

    function renderChart(){
      const fp = fullPool();
      chart.innerHTML = fp.map(x => `
        <div class="cell"><div class="k">${x.k}</div><div class="r">${x.r}</div></div>
      `).join('');
      // adjust pool max and clamp current value
      optPool.max = fp.length;
      if (state.poolSize > fp.length) state.poolSize = fp.length;
      optPool.value = state.poolSize;
    }

    function setMessage(text, ok){
      msgEl.textContent = text || ' ';
      msgEl.className = 'msg' + (text ? (ok ? ' ok' : ' err') : '');
    }

    function updateStats(){
      statScore.textContent = state.score;
      statAsked.textContent = state.asked;
      const acc = state.asked ? Math.round((state.score/state.asked)*100) : 0;
      statAcc.textContent = acc + '%';
      statStreak.textContent = state.streak;
      statBest.textContent = state.bestStreak;
      kbdHint.textContent = `Press 1–${state.choicesCount} to answer · Space to skip`;
      
      // Update title and hint based on mode and script type
      let scriptName, scriptChar;
      if (state.scriptType === 'hiragana') {
        scriptName = 'Hiragana';
        scriptChar = 'ひらがな';
      } else if (state.scriptType === 'katakana') {
        scriptName = 'Katakana';
        scriptChar = 'カタカナ';
      } else if (state.scriptType === 'mixed') {
        scriptName = 'Mixed Kana';
        scriptChar = 'ひらがな・カタカナ';
      }
      
      if (state.mode === 'r2k') {
        titleEl.textContent = `${scriptName} Quiz — Romaji → ${scriptChar}`;
        document.querySelector('#hint').textContent = 'Romaji';
      } else {
        titleEl.textContent = `${scriptName} Quiz — ${scriptChar} → Romaji`;
        document.querySelector('#hint').textContent = scriptName === 'Mixed Kana' ? 'Kana' : scriptName;
      }
    }

    function stopTimer(){ if (state.tick) { clearInterval(state.tick); state.tick = null; } }

    function renderTimer(){
      const m = Math.floor(state.seconds/60); const s = String(state.seconds%60).padStart(2,'0');
      timerEl.textContent = `⏱️ ${m}:${s}`;
    }

    function startQuiz(){
      state.inProgress = true;
      state.score = 0; state.asked = 0; state.history = []; state.message='';
      state.streak = 0; state.bestStreak = 0; state.seconds = 0;
      preStart.hidden = true; quiz.hidden = false; historyWrap.hidden = true;
      setMessage('', true);
      updateStats();
      buildPoolAndQueue();
      stopTimer();
      if (state.timerOn){ state.tick = setInterval(()=>{ state.seconds++; renderTimer(); }, 1000); }
      newQuestion(null);
    }

    function newQuestion(prevCorrect){
      if (state.queue.length === 0) {
        state.queue = state.currentPool.slice().sort(() => Math.random() - 0.5); // new cycle when exhausted
      }
      const qItem = state.queue.pop();
      let options;
      if (state.mode === 'r2k') {
        const distractors = state.currentPool
          .filter(x=>x.k!==qItem.k)
          .sort(()=>Math.random()-0.5)
          .slice(0, Math.max(0, state.choicesCount-1));
        options = [qItem.k, ...distractors.map(d=>d.k)].sort(()=>Math.random()-0.5).slice(0, state.choicesCount);
        state.question = { prompt: qItem.r, answer: qItem.k, options };
      } else {
        const distractors = state.currentPool
          .filter(x=>x.r!==qItem.r)
          .sort(()=>Math.random()-0.5)
          .slice(0, Math.max(0, state.choicesCount-1));
        options = [qItem.r, ...distractors.map(d=>d.r)].sort(()=>Math.random()-0.5).slice(0, state.choicesCount);
        state.question = { prompt: qItem.k, answer: qItem.r, options };
      }
      promptEl.textContent = state.question.prompt;
      choicesEl.innerHTML = '';
      options.forEach((opt, idx)=>{
        const b = document.createElement('button');
        b.className = 'choice';
        b.innerHTML = `<strong>${idx+1}.</strong> ${opt}`;
        b.addEventListener('click', ()=> choose(opt));
        choicesEl.appendChild(b);
      });
      if (prevCorrect !== null) { state.asked++; }
      updateStats();
    }

    function pushHistory(entry){
      state.history.push(entry);
      const recent = state.history.slice(-16).reverse();
      historyEl.innerHTML = recent.map(h=>{
        const good = h.correct;
        return `<div class="h-item ${good? 'h-good':'h-bad'}">
          <div class="sub">${h.r}</div>
          <div style="font-size:22px; font-weight:800;">${h.k}</div>
          ${good? '' : `<div class="sub" style="margin-top:4px;">You chose: ${h.chosen}</div>`}
        </div>`
      }).join('');
      historyWrap.hidden = state.history.length === 0;
    }

    function choose(k){
      if (!state.question) return;
      const correct = (k === state.question.answer);
      if (correct) state.score++;
      setMessage(correct ? '✅ Correct!' : `❌ Oops — ${state.question.prompt} = ${state.question.answer}`, correct);
      // Store both forms consistently for history
      if (state.mode === 'r2k') {
        pushHistory({ r: state.question.prompt, k: state.question.answer, correct, chosen: k });
      } else {
        // In k2r mode, prompt is kana, answer is romaji
        pushHistory({ r: state.question.answer, k: state.question.prompt, correct, chosen: k });
      }
      state.streak = correct ? state.streak + 1 : 0;
      state.bestStreak = Math.max(state.bestStreak, state.streak);
      updateStats();
      setTimeout(()=>{ setMessage('', true); newQuestion(correct); }, 600);
    }

    function reveal(){ if (state.question) choose(state.question.answer); }
    function skip(){
      if (!state.question) return;
      if (state.mode === 'r2k') {
        pushHistory({ r: state.question.prompt, k: state.question.answer, correct:false, chosen:'(skipped)' });
      } else {
        // In k2r mode, store romaji in r and kana in k for consistency
        pushHistory({ r: state.question.answer, k: state.question.prompt, correct:false, chosen:'(skipped)' });
      }
      state.streak = 0;
      newQuestion(false);
      updateStats();
    }

    // Event wiring
    optScript.addEventListener('change', e=>{ 
      state.scriptType = e.target.value; 
      renderChart(); 
      updateStats();
      if (state.inProgress) { 
        buildPoolAndQueue(); 
        newQuestion(null); 
      }
    });
    optDakuten.addEventListener('change', e=>{ state.includeDakuten = e.target.checked; renderChart(); });
    optYoon.addEventListener('change', e=>{ state.includeYoon = e.target.checked; renderChart(); });
    optChoices.addEventListener('change', e=>{ state.choicesCount = Number(e.target.value); updateStats(); });
    optDirection.addEventListener('change', e=>{ state.mode = e.target.value; updateStats(); if (!state.inProgress) return; buildPoolAndQueue(); newQuestion(null); });
    optPool.addEventListener('change', e=>{ const fp = fullPool(); const v = Math.max(10, Math.min(fp.length, Number(e.target.value)||10)); state.poolSize = v; e.target.value = v; });
    optTimer.addEventListener('change', e=>{ state.timerOn = e.target.checked; if (!state.inProgress) return; stopTimer(); if (state.timerOn) { state.tick = setInterval(()=>{ state.seconds++; renderTimer(); }, 1000); } else { renderTimer(); } });
    btnStart.addEventListener('click', startQuiz);
    btnSkip.addEventListener('click', skip);
    btnReveal.addEventListener('click', reveal);

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if (!state.inProgress || !state.question) return;
      const k = e.key;
      if (/^[1-9]$/.test(k)){
        const idx = Number(k) - 1;
        if (idx < state.question.options.length) choose(state.question.options[idx]);
      } else if (k === ' ') { e.preventDefault(); skip(); }
    });

    // Initial render
    renderChart();
    updateStats();
    renderTimer();
  </script>
</body>
</html>
